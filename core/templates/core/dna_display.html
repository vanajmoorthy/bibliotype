{% extends 'core/base.html' %}
{% load humanize %}
{% block content %}
    <div class="mx-auto h-full max-w-4xl space-y-8 p-2">
        {# =================================================================== #}
        {# --- STATE 1: USER IS LOGGED IN AND ACTIVELY PROCESSING --- #}
        {# =================================================================== #}
        {% if is_processing %}
            <div class="flex h-full flex-col p-0">
                <div class="w-full">
                    <h1 class="mt-8 text-center text-4xl font-bold tracking-widest uppercase sm:text-5xl">
                        <span class="relative z-10">Generating Your Reading DNA</span>
                    </h1>
                </div>
                <div class="flex flex-grow items-center justify-center">
                    <div class="w-full">
                        <div class="shadow-neo border-2 border-[var(--color-brand-text)] bg-white p-8">
                            <div class="flex flex-col items-center justify-center space-y-4">
                                <svg
                                    class="h-10 w-10 animate-spin text-[var(--color-brand-text)]"
                                    xmlns="http://www.w3.org/2000/svg"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <circle
                                        class="opacity-25"
                                        cx="12"
                                        cy="12"
                                        r="10"
                                        stroke="currentColor"
                                        stroke-width="4"
                                    ></circle>
                                    <path
                                        class="opacity-75"
                                        fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                    ></path>
                                </svg>
                                <p class="text-center text-2xl font-bold text-[var(--color-brand-text)] uppercase">
                                    Analyzing Your Library
                                </p>
                                <p class="text-center text-lg">This page will refresh automatically when it's ready!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                function checkStatus() {
                    fetch("{% url 'core:api_check_dna_status' %}")
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.status === "SUCCESS") {
                                window.location.href = "{% url 'core:display_dna' %}";
                            } else {
                                setTimeout(checkStatus, 5000);
                            }
                        })
                        .catch((error) => {
                            console.error("Error polling for DNA status:", error);
                            // In case of network error, keep trying.
                            setTimeout(checkStatus, 5000);
                        });
                }

                document.addEventListener("DOMContentLoaded", function () {
                    checkStatus();
                });
            </script>

            {# =================================================================== #}
            {# --- STATE 2: USER (LOGGED IN OR ANON) HAS DNA TO DISPLAY --- #}
            {# =================================================================== #}
        {% elif dna %}
            {{ dna|json_script:"dna-data" }}

            <h1 class="mb-8 text-center text-5xl font-bold tracking-widest uppercase">
                <span class="relative z-10">
                    {% if user.is_authenticated %}
                        <div
                            x-data="{
                        editing: false,
                        newName: '{{ user.username|escapejs }}',
                        originalName: '{{ user.username|escapejs }}',
                        errorMessage: '',

                        get isNewNameValid() {
                            return this.newName.trim() !== '' && this.newName.length <= 15;
                        },
                        
                        updateUsername: function() {
                            if (!this.isNewNameValid) return;
                            this.errorMessage = '';
                            fetch('{% url "core:api_update_username" %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ username: this.newName })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    window.location.reload();
                                } else {
                                    this.errorMessage = data.message;
                                }
                            })
                            .catch(() => {
                                this.errorMessage = 'Could not connect to the server.';
                            });
                        }
                    }"
                            class="inline-block"
                        >
                            <!-- VIEW STATE (FIXED) -->
                            <div
                                x-show="!editing"
                                class="flex flex-col items-center justify-center gap-y-2 text-4xl sm:text-5xl md:flex-row md:gap-x-3"
                            >
                                <!-- [ANYA]'S -->
                                <div class="inline-flex items-center">
                                    <!-- Clickable username area -->
                                    <div
                                        @click="editing = true; $nextTick(() => $refs.usernameInput.select())"
                                        class="group relative cursor-pointer"
                                    >
                                        <!-- Yellow background -->
                                        <span
                                            class="bg-brand-yellow group-hover:border-brand-text absolute inset-0 z-10 border-2 border-transparent transition-colors"
                                        ></span>
                                        <!-- Username text -->
                                        <span class="relative z-20 px-2" x-text="originalName"></span>
                                        <!-- Pencil Icon -->
                                        <div class="text-brand-text absolute -right-2 -bottom-2 z-30">
                                            <svg
                                                class="h-7 w-7"
                                                xmlns="http://www.w3.org/2000/svg"
                                                viewBox="0 0 16 16"
                                                fill="currentColor"
                                            >
                                                <path
                                                    d="M14 0l2 2-2 2-2-2 2-2zM12 2l2 2-8 8H4v-2l8-8zM2 12v2h2l-l-2-2z"
                                                />
                                            </svg>
                                        </div>
                                    </div>
                                    <!-- Possessive 's -->
                                    <span x-text="originalName.toLowerCase().endsWith('s') ? `'` : `'s`"></span>
                                </div>

                                <!-- READING DNA -->
                                <span>Reading DNA</span>
                            </div>

                            <!-- EDIT STATE -->
                            <div x-show="editing" x-cloak class="flex justify-center">
                                <form
                                    @submit.prevent="updateUsername"
                                    @keydown.escape.window="editing = false; newName = originalName"
                                    class="inline-flex items-stretch gap-4"
                                >
                                    <input
                                        type="text"
                                        x-ref="usernameInput"
                                        x-model="newName"
                                        maxlength="15"
                                        class="border-brand-text focus:border-brand-purple w-full border-2 bg-white p-1 text-4xl font-bold tracking-widest uppercase focus:outline-none sm:text-5xl"
                                    />
                                    <button
                                        type="submit"
                                        class="bg-brand-green text-brand-text border-brand-text shadow-neo-sm border-2 px-4 py-2 text-xl font-bold transition-colors hover:shadow-none active:translate-x-0.5 active:translate-y-0.5"
                                        :disabled="!isNewNameValid"
                                        :class="{ 'opacity-50 cursor-not-allowed': !isNewNameValid }"
                                    >
                                        Save
                                    </button>
                                </form>
                            </div>
                            <div x-show="editing && newName.length > 15" class="mt-2 text-lg font-bold text-red-600">
                                Display name cannot be more than 15 characters.
                            </div>
                            <div
                                x-show="editing && errorMessage"
                                x-text="errorMessage"
                                class="mt-2 text-lg font-bold text-red-600"
                            ></div>
                        </div>
                    {% else %}
                        Your Reading DNA
                    {% endif %}
                </span>
            </h1>

            {% if dna.reading_vibe %}
                <div
                    id="vibe-container"
                    class="mb-8 flex flex-wrap items-center justify-center gap-x-4 gap-y-2 text-center text-xl italic"
                >
                    {% for phrase in dna.reading_vibe %}
                        <span class="vibe-item whitespace-nowrap text-gray-600">{{ phrase }}</span>
                        {% if not forloop.last %}
                            <span class="vibe-separator font-bold text-blue-400">·</span>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}

            {% if dna.reader_type %}
                <div class="bg-brand-purple border-brand-text shadow-neo border-2 p-6 text-center">
                    <div class="text-lg uppercase">Your Reader Type is...</div>
                    <div class="mt-1 text-5xl font-bold tracking-widest uppercase">{{ dna.reader_type }}</div>
                    {% if dna.reader_type_explanation %}
                        <p class="mx-auto mt-4 max-w-2xl text-lg">{{ dna.reader_type_explanation }}</p>
                    {% endif %}
                </div>
            {% endif %}

            {% if dna.top_reader_types %}
                <div class="border-brand-text shadow-neo border-2 bg-white p-6">
                    <h2 class="mb-4 text-2xl font-bold uppercase">Your Top Reader Traits</h2>
                    <ol class="space-y-2 text-lg">
                        {% for item in dna.top_reader_types %}
                            {% if forloop.first %}
                                {% with bgcolor='bg-yellow-300' bordercolor='border-yellow-500' %}
                                    {% include 'core/partials/leaderboard_item.html' %}
                                {% endwith %}
                            {% elif forloop.counter == 2 %}
                                {% with bgcolor='bg-gray-300' bordercolor='border-gray-500' %}
                                    {% include 'core/partials/leaderboard_item.html' %}
                                {% endwith %}
                            {% elif forloop.counter == 3 %}
                                {% with bgcolor='bg-amber-500' bordercolor='border-amber-700' %}
                                    {% include 'core/partials/leaderboard_item.html' %}
                                {% endwith %}
                            {% endif %}
                        {% endfor %}
                    </ol>
                </div>
            {% endif %}

            <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                <div class="bg-brand-yellow border-brand-text shadow-neo border-2 p-6 text-center">
                    <div class="text-5xl font-bold">{{ dna.user_stats.total_books_read }}</div>
                    <div class="mt-2 text-lg uppercase">Total Books Read</div>
                </div>
                <div class="bg-brand-pink border-brand-text shadow-neo border-2 p-6 text-center">
                    <div class="text-5xl font-bold">{{ dna.user_stats.total_pages_read|intcomma }}</div>
                    <div class="mt-2 text-lg uppercase">Total Pages Read</div>
                </div>
                <div class="bg-brand-cyan border-brand-text shadow-neo border-2 p-6 text-center">
                    <div class="text-5xl font-bold">{{ dna.average_rating_overall }}</div>
                    <div class="mt-2 text-lg uppercase">Overall Rating</div>
                </div>
            </div>

            <div class="border-brand-text shadow-neo border-2 bg-white p-6">
                <h2 class="mb-4 text-2xl font-bold uppercase">Comparative Analytics</h2>
                {% if dna.bibliotype_percentiles %}
                    <div class="space-y-4 text-lg">
                        <div class="border-brand-text shadow-neo-sm border-2 bg-gray-50 p-3">
                            <p>
                                Your average book length is <strong>{{ dna.user_stats.avg_book_length }} pages</strong>.
                                <span class="text-gray-600"
                                    >(Global avg: ~{{ dna.global_averages.avg_book_length_pages }})</span
                                >
                            </p>
                            <p class="mt-1 text-base">
                                This is longer than
                                <strong>{{ dna.bibliotype_percentiles.avg_book_length|floatformat:1 }}%</strong> of
                                other Bibliotype readers.
                            </p>
                        </div>
                        <div class="border-brand-text shadow-neo-sm border-2 bg-gray-50 p-3">
                            <p>
                                The average age of books you read is from
                                <strong>{{ dna.user_stats.avg_publish_year|floatformat:0 }}</strong>.
                                <span class="text-gray-600"
                                    >(Global avg: ~{{ dna.global_averages.avg_publish_year }})</span
                                >
                            </p>
                            <p class="mt-1 text-base">
                                Your reading tastes are older than
                                <strong>{{ dna.bibliotype_percentiles.avg_publish_year|floatformat:1 }}%</strong> of
                                other Bibliotype readers.
                            </p>
                        </div>
                        <div class="border-brand-text shadow-neo-sm border-2 bg-gray-50 p-3">
                            <p>You have read <strong>{{ dna.user_stats.total_books_read }} books</strong> in total.</p>
                            <p class="mt-1 text-base">
                                You've read more books than
                                <strong>{{ dna.bibliotype_percentiles.total_books_read|floatformat:1 }}%</strong> of
                                other Bibliotype readers.
                            </p>
                        </div>
                    </div>
                {% else %}
                    <p class="text-lg text-gray-600">
                        We're just getting started! Once a few more readers have submitted their DNA, you'll see your
                        community rankings and percentiles here.
                    </p>
                {% endif %}
            </div>

            <div class="grid grid-cols-1 gap-8 md:grid-cols-2">
                <div class="border-brand-text shadow-neo border-2 bg-white p-6">
                    <h2 class="mb-4 text-2xl font-bold uppercase">Your Most Niche Read</h2>
                    {% if dna.most_niche_book %}
                        <p class="text-xl font-bold">{{ dna.most_niche_book.title }}</p>
                        <p class="text-lg">by {{ dna.most_niche_book.author }}</p>
                        <p class="bg-brand-cyan border-brand-text mt-2 inline-block border-2 px-2 py-1 text-base">
                            Only {{ dna.most_niche_book.read_count }} Bibliotype user(s) have read this!
                        </p>
                    {% else %}
                        <p class="text-lg">Not enough data to determine your niche reads yet.</p>
                    {% endif %}
                </div>
        
        <div class="border-brand-text shadow-neo border-2 bg-white p-6">
    <h2 class="mb-4 text-center text-2xl font-bold uppercase">How Mainstream Your Taste Is</h2>

    <!-- Alpine.js component for the gauge logic -->
    <div x-data="{
        score: {{ dna.mainstream_score_percent }},
        get rotation() {
            // Clamps the score between 0 and 100
            const clampedScore = Math.max(0, Math.min(100, this.score));
            // Maps the 0-100 score to a -90deg (left) to +90deg (right) rotation
            return (clampedScore / 100) * 180 - 90;
        }
    }">
        <!-- Gauge container: a 2:1 rectangle that hides the bottom of the circle -->
        <div class="relative mx-auto h-32 w-64 overflow-hidden">

            <!-- The gradient circle using a 5-color conic gradient. Positioned behind the needle. -->
            <div class="absolute top-0 left-0 h-64 w-64 rounded-full border-4 border-brand-text z-10"
                 style="background-image: conic-gradient(
                    from 180deg,
                    #00c27a 0% 20%,      /* Niche */
                    #66d19e 20% 40%,     /* Leaning Niche */
                    #ffc107 40% 60%,     /* Balanced */
                    #ff8c42 60% 80%,     /* Leaning Mainstream */
                    #ff5c5c 80% 100%      /* Mainstream */
                 );">
            </div>

            <!-- Curved text labels above the gauge -->
            <div class="absolute top-0 left-0 h-64 w-64 z-15">
                <!-- "not very" label (left side) -->
                <div class="absolute top-8 left-8 text-sm font-bold text-brand-text transform -rotate-45 origin-center">
                    not very
                </div>
                <!-- "kinda" label (center) -->
                <div class="absolute top-4 left-1/2 transform -translate-x-1/2 text-sm font-bold text-brand-text">
                    kinda
                </div>
                <!-- "super mainstream" label (right side) -->
                <div class="absolute top-8 right-8 text-sm font-bold text-brand-text transform rotate-45 origin-center">
                    super mainstream
                </div>
            </div>

            <!-- The needle, with a higher z-index to ensure it's on top of the gradient -->
            <div class="absolute bottom-0 left-1/2 h-28 w-2 origin-bottom bg-brand-text transition-transform duration-500 z-20"
                 :style="`transform: translateX(-50%) rotate(${rotation}deg)`">
            </div>

            <!-- The pivot point for the needle, with the highest z-index -->
            <div class="absolute bottom-1 left-1/2 h-6 w-6 -translate-x-1/2 rounded-full border-4 border-white bg-brand-text z-30"></div>
        </div>

        <!-- The descriptive text below the meter -->
        <p class="mt-4 text-center text-lg">
            <strong x-text="score + '%'"></strong> of the books in your library are considered
            "mainstream," based on author and publisher popularity.
        </p>
    </div>
</div>

            </div>

            <div class="border-brand-text shadow-neo border-2 bg-white p-6">
                <h2 class="mb-4 text-2xl font-bold uppercase">Books Read Per Year</h2>
                <canvas id="booksByYearChart"></canvas>
            </div>

    
            <div class="grid grid-cols-1 gap-8 md:grid-cols-2">
                
                <!-- REVISED: Top Genres section -->
                <div x-data="{
                    colors: ['#ffb4dd', '#40e7aa', '#ffa75e', '#8bbfff', '#FFE9CE', '#ff647c', '#ffe56c', '#A1CDF1', '#9af6d4', '#fe9393']
          
                }" class="border-brand-text shadow-neo relative overflow-hidden border-2 bg-white p-6">
                    <h2 class="mb-4 text-2xl font-bold uppercase">Top Genres</h2>
                    {% if dna.top_genres %}
                        <ol class="space-y-2 text-lg">
                            {% for genre, count in dna.top_genres %}
                                <li class="capitalize">
                                    <span class="border-brand-text border-2 px-2 py-1 font-bold mr-2"
                                          :style="{ 'background-color': colors[{{ forloop.counter0 }}] }">
                                        {{ genre }}
                                    </span>
                                    ({{ count }} books)
                                </li>
                            {% endfor %}
                        </ol>
                        <div class="absolute top-2 right-2 h-28 w-28 md:h-32 md:w-32"><canvas id="topGenresChart"></canvas></div>
                    {% else %}
                        <p class="text-lg">Not enough genre data to display.</p>
                    {% endif %}
                </div>

                <!-- REVISED: Top Authors section -->
               <div x-data="{
                    colors: ['#ffb4dd', '#40e7aa', '#ffa75e', '#8bbfff', '#FFE9CE', '#ff647c', '#ffe56c', '#A1CDF1', '#9af6d4', '#fe9393']
          
                }" class="border-brand-text shadow-neo relative overflow-hidden border-2 bg-white p-6">
                    <h2 class="mb-4 text-2xl font-bold uppercase">Top Authors</h2>
                    {% if dna.top_authors %}
                        <ol class="space-y-2 text-lg">
                            {% for author, count in dna.top_authors %}
                                <li>
                                    <span class="bg-brand-cyan border-brand-text border-2 px-2 py-1 font-bold mr-2" 
                                          :style="{ 'background-color': colors[{{ forloop.counter0 }}] }">
                                        {{ author }}
                                    </span>
                                    ({{ count }} books)
                                </li>
                            {% endfor %}
                        </ol>
                        <div class="absolute top-2 right-2 h-28 w-28 md:h-32 md:w-32"><canvas id="topAuthorsChart"></canvas></div>
                    {% else %}
                        <p class="text-lg">Not enough author data to display.</p>
                    {% endif %}
                </div>
            </div>

  

            <div class="border-brand-text shadow-neo border-2 bg-white p-6">
                <h2 class="mb-4 text-2xl font-bold uppercase">Review Analysis</h2>
                <div class="grid grid-cols-1 gap-6 text-lg md:grid-cols-2">
                    <div>
                        <h3 class="text-xl font-bold uppercase">Most Positive Review</h3>
                        {% if dna.most_positive_review %}
                            <p class="mt-2 font-bold">{{ dna.most_positive_review.Title }}</p>
                            <blockquote class="border-brand-text shadow-neo-sm mt-2 border-2 bg-gray-100 p-3">
                                "{{ dna.most_positive_review.my_review }}"
                            </blockquote>
                        {% else %}
                            <p class="mt-2">No reviews found.</p>
                        {% endif %}
                    </div>
                    <div>
                        <h3 class="text-xl font-bold uppercase">Most Negative Review</h3>
                        {% if dna.most_negative_review %}
                            <p class="mt-2 font-bold">{{ dna.most_negative_review.Title }}</p>
                            <blockquote class="border-brand-text shadow-neo-sm mt-2 border-2 bg-gray-100 p-3">
                                "{{ dna.most_negative_review.my_review }}"
                            </blockquote>
                        {% else %}
                            <p class="mt-2">No reviews found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="border-brand-text shadow-neo border-2 bg-white p-6">
                <h2 class="mb-4 text-2xl font-bold uppercase">Most "Controversial" Ratings 🤯</h2>
                <p class="mb-4 text-lg">Books where your rating differs most from the Goodreads average.</p>
                <div class="space-y-4 text-lg">
                    {% for book in dna.top_controversial_books %}
                        <div class="border-brand-text shadow-neo-sm border-2 bg-gray-50 p-3">
                            <p class="font-bold">{{ book.Title }}</p>
                            <div class="mt-1 flex items-center justify-between text-base">
                                <span
                                    >Your Rating:
                                    <span class="text-xl font-bold">{{ book.my_rating|floatformat:1 }}★</span></span
                                >
                                <span
                                    >Goodreads Avg:
                                    <span class="text-xl font-bold"
                                        >{{ book.average_rating|floatformat:1 }}★</span
                                    ></span
                                >
                                <span
                                    class="bg-brand-purple text-brand-text border-brand-text border-2 px-2 py-1 font-bold"
                                    >Diff: {{ book.rating_difference|floatformat:1 }}</span
                                >
                            </div>
                        </div>
                        {% empty %}
                        <p>Not enough data to calculate controversial ratings.</p>
                    {% endfor %}
                </div>
            </div>

            {% if user.is_authenticated %}
                <div class="grid grid-cols-1 items-center gap-6 md:grid-cols-3">
                    <div
                        class="border-brand-text shadow-neo flex h-full items-center border-2 bg-white p-4 md:col-span-2"
                    >
                        <div class="flex-grow">
                            {% if user_profile.is_public %}
                                <h3 class="text-xl font-bold uppercase">
                                    Your profile is
                                    <span class="bg-brand-green border-brand-text border-2 px-2 py-1 font-bold"
                                        >Public</span
                                    >.
                                    <a
                                        href="{% url 'core:public_profile' username=user.username %}"
                                        class="hover:bg-brand-yellow ml-2 underline"
                                        target="_blank"
                                        >/u/{{ user.username }}</a
                                    >
                                </h3>
                            {% else %}
                                <h3 class="text-xl font-bold uppercase">
                                    Your profile is
                                    <span class="bg-brand-pink border-brand-text border-2 px-2 py-1 font-bold"
                                        >Private</span
                                    >.
                                </h3>
                            {% endif %}
                        </div>
                        <form action="{% url 'core:update_privacy' %}" method="post" class="ml-4">
                            {% csrf_token %}
                            {% if user_profile.is_public %}
                                <input type="hidden" name="is_public" value="false" />
                                <button
                                    type="submit"
                                    class="bg-brand-pink text-brand-text border-brand-text shadow-neo-sm hover:bg-brand-yellow border-2 px-4 py-2 font-bold"
                                >
                                    Make Private
                                </button>
                            {% else %}
                                <input type="hidden" name="is_public" value="true" />
                                <button
                                    type="submit"
                                    class="bg-brand-green text-brand-text border-brand-text shadow-neo-sm hover:bg-brand-yellow border-2 px-4 py-2 font-bold"
                                >
                                    Make Public
                                </button>
                            {% endif %}
                        </form>
                    </div>
                    <div
                        class="border-brand-text shadow-neo flex h-full items-center justify-center border-2 bg-white p-4"
                    >
                        <a
                            href="{% url 'core:home' %}"
                            class="bg-brand-purple border-brand-text shadow-neo-sm hover:bg-opacity-90 block w-full border-2 px-4 py-2 text-center font-bold"
                            >Update Bibliotype</a
                        >
                    </div>
                </div>
            {% else %}
                <div class="bg-brand-purple border-brand-text shadow-neo border-2 p-6 text-center">
                    <h2 class="text-2xl font-bold uppercase">Enjoying Your Bibliotype?</h2>
                    <p class="mt-2 text-lg">
                        <a href="{% url 'core:signup' %}" class="hover:bg-brand-yellow underline"
                            >Create a free account</a
                        >
                        to save your DNA, track your history, and share it with friends.
                    </p>
                </div>
            {% endif %}

            <script>
                function updateVibeSeparators() {
                    const vibeContainer = document.getElementById("vibe-container");
                    if (!vibeContainer) return;

                    const items = vibeContainer.querySelectorAll(".vibe-item");
                    const separators = vibeContainer.querySelectorAll(".vibe-separator");

                    if (items.length < 2) return;

                    // 1. First, show all separators
                    separators.forEach((sep) => (sep.style.display = "inline"));

                    // 2. Loop through items to find line breaks
                    for (let i = 0; i < items.length - 1; i++) {
                        const currentItem = items[i];
                        const nextItem = items[i + 1];

                        // If the next item is on a new line, hide the separator after the current one
                        if (nextItem.offsetTop > currentItem.offsetTop) {
                            const separatorToHide = separators[i];
                            if (separatorToHide) {
                                separatorToHide.style.display = "none";
                            }
                        }
                    }
                }

                document.addEventListener("DOMContentLoaded", function () {
                    updateVibeSeparators();
                    const dnaData = JSON.parse(document.getElementById("dna-data").textContent);
                    Chart.defaults.font.family = "VT323";
                    Chart.defaults.font.size = 16;
                    Chart.defaults.color = "#1f2937";
                    const booksByYearCtx = document.getElementById("booksByYearChart").getContext("2d");
                    new Chart(booksByYearCtx, {
                        type: "bar",
                        data: {
                            labels: dnaData.stats_by_year.map((d) => d.year),
                            datasets: [
                                {
                                    label: "# of Books",
                                    data: dnaData.stats_by_year.map((d) => d.count),
                                    backgroundColor: "#fde047",
                                    borderColor: "#1f2937",
                                    borderWidth: 2,
                                },
                            ],
                        },
                        options: {
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { color: "#e5e7eb" }, ticks: { stepSize: 1 } },
                                x: { grid: { display: false } },
                            },
                        },
                    });
                const topGenresCtx = document.getElementById("topGenresChart").getContext("2d");
                    const topGenresData = dnaData.top_genres;
                    
                    // NEW: Parse list of tuples instead of an object
                    const genreLabels = topGenresData.map(item => item[0]);
                    const genreValues = topGenresData.map(item => item[1]);
                    
                    // Define the color palette once to be reused
                    const chartColors = ['#ffb4dd', '#40e7aa', '#ffa75e', '#8bbfff', '#FFE9CE', '#ff647c', '#ffe56c', '#A1CDF1', '#9af6d4', '#fe9393'];
                    
                    new Chart(topGenresCtx, {
                        type: "doughnut",
                        data: {
                            labels: genreLabels,
                            datasets: [
                                {
                                    label: "Genres",
                                    data: genreValues,
                                    backgroundColor: chartColors,
                                    // NEW: Add black borders to the chart segments
                                    borderColor: '#1f2937', 
                                    borderWidth: 2,
                                },
                            ],
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.label || "";
                                            if (label) {
                                                label += ": ";
                                            }
                                            if (context.parsed !== null) {
                                                label += context.parsed;
                                            }
                                            return label;
                                        },
                                    },
                                },
                            },
                        },
                    });
                    const topAuthorsCtx = document.getElementById("topAuthorsChart").getContext("2d");
    const topAuthorsData = dnaData.top_authors;

    // NEW: Parse list of tuples instead of an object
    const authorLabels = topAuthorsData.map(item => item[0]);
    const authorValues = topAuthorsData.map(item => item[1]);

    new Chart(topAuthorsCtx, {
        type: "doughnut",
        data: {
            labels: authorLabels,
            datasets: [
                {
                    label: "Authors",
                    data: authorValues,
                    backgroundColor: chartColors, // Reusing the same palette
                    // NEW: Add black borders to the chart segments
                    borderColor: '#1f2937',
                    borderWidth: 2,
                },
            ],
        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            let label = context.label || "";
                                            if (label) {
                                                label += ": ";
                                            }
                                            if (context.parsed !== null) {
                                                label += context.parsed;
                                            }
                                            return label;
                                        },
                                    },
                                },
                            },
                        },
                    });
                });
                window.addEventListener("resize", updateVibeSeparators);
            </script>

            {# =================================================================== #}
            {# --- STATE 3: LOGGED IN USER, NO DNA, NOT PROCESSING (WELCOME) --- #}
            {# =================================================================== #}
        {% else %}
            <div class="flex h-full flex-col p-4">
                <div class="w-full">
                    <h1 class="mb-8 text-center text-5xl font-bold tracking-widest uppercase">
                        <span class="relative z-10">
                            <div
                                x-data="{
                        editing: false,
                        newName: '{{ user.username|escapejs }}',
                        originalName: '{{ user.username|escapejs }}',
                        errorMessage: '',
                        
                        updateUsername: function() {
                            this.errorMessage = '';
                            fetch('{% url "core:api_update_username" %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ username: this.newName })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    window.location.reload();
                                } else {
                                    this.errorMessage = data.message;
                                }
                            })
                            .catch(() => {
                                this.errorMessage = 'Could not connect to the server.';
                            });
                        }
                    }"
                                class="inline-block"
                            >
                                <!-- VIEW STATE (FIXED) -->
                                <div
                                    x-show="!editing"
                                    class="flex flex-col items-center justify-center gap-y-2 text-4xl sm:text-5xl md:flex-row md:gap-x-3"
                                >
                                    <!-- [ANYA]'S -->
                                    <div class="inline-flex items-center">
                                        <!-- Clickable username area -->
                                        <div
                                            @click="editing = true; $nextTick(() => $refs.usernameInput.select())"
                                            class="group relative cursor-pointer"
                                        >
                                            <!-- Yellow background -->
                                            <span
                                                class="bg-brand-yellow group-hover:border-brand-text absolute inset-0 z-10 border-2 border-transparent transition-colors"
                                            ></span>
                                            <!-- Username text -->
                                            <span class="relative z-20 px-2" x-text="originalName"></span>
                                            <!-- Pencil Icon -->
                                            <div class="text-brand-text absolute -right-2 -bottom-2 z-30">
                                                <svg
                                                    class="h-7 w-7"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    viewBox="0 0 16 16"
                                                    fill="currentColor"
                                                >
                                                    <path
                                                        d="M14 0l2 2-2 2-2-2 2-2zM12 2l2 2-8 8H4v-2l8-8zM2 12v2h2l-l-2-2z"
                                                    />
                                                </svg>
                                            </div>
                                        </div>
                                        <!-- Possessive 's -->
                                        <span x-text="originalName.toLowerCase().endsWith('s') ? `'` : `'s`"></span>
                                    </div>

                                    <!-- READING DNA -->
                                    <span>Reading DNA</span>
                                </div>
                                <!-- EDIT STATE -->
                                <form
                                    x-show="editing"
                                    x-cloak
                                    @submit.prevent="updateUsername"
                                    @keydown.escape.window="editing = false; newName = originalName"
                                    class="inline-flex items-stretch gap-4"
                                >
                                    <input
                                        type="text"
                                        x-ref="usernameInput"
                                        x-model="newName"
                                        class="border-brand-text focus:border-brand-purple w-full border-2 bg-white p-1 text-5xl font-bold tracking-widest uppercase focus:outline-none"
                                    />
                                    <button
                                        type="submit"
                                        class="bg-brand-green text-brand-text border-brand-text shadow-neo-sm cursor-pointer border-2 px-4 py-2 text-xl font-bold hover:shadow-none active:translate-x-0.5 active:translate-y-0.5"
                                    >
                                        Save
                                    </button>
                                </form>
                                <div
                                    x-show="editing && errorMessage"
                                    x-text="errorMessage"
                                    class="mt-2 text-lg font-bold text-red-600"
                                ></div>
                            </div>
                        </span>
                    </h1>
                </div>
                <div class="flex flex-grow items-center justify-center">
                    <div class="w-full text-center">
                        <h2 class="mb-4 text-4xl font-bold uppercase">uh oh</h2>
                        <p class="text-brand-text text-xl italic">
                            Your account is ready but you haven't uploaded your data yet! To generate your Reading DNA,
                            please go to the homepage and upload your library export.
                        </p>
                        <a
                            href="{% url 'core:home' %}"
                            class="bg-brand-green text-brand-text border-brand-text shadow-neo-sm hover:bg-opacity-90 mt-8 inline-block border-2 px-3 py-3 text-center font-bold uppercase"
                        >
                            Upload Your Library File
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}
