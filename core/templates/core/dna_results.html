{% extends 'core/base.html' %}
{% load humanize %}

{% block content %}
{{ dna|json_script:"dna-data" }}

<div class="max-w-4xl mx-auto space-y-8 p-4">
    <h1 class="text-5xl font-bold mb-8 text-center uppercase tracking-widest">Your Reading DNA</h1>

    <!-- Key Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-brand-yellow p-6 border-2 border-brand-text shadow-neo text-center">
            <div class="text-5xl font-bold">{{ dna.total_books_read }}</div>
            <div class="text-lg uppercase mt-2">Total Books Read</div>
        </div>
        <div class="bg-brand-pink p-6 border-2 border-brand-text shadow-neo text-center">
            <div class="text-5xl font-bold">{{ dna.total_pages_read|intcomma }}</div>
            <div class="text-lg uppercase mt-2">Total Pages Read</div>
        </div>
        <div class="bg-brand-cyan p-6 border-2 border-brand-text shadow-neo text-center">
            <div class="text-5xl font-bold">{{ dna.average_rating_overall }}</div>
            <div class="text-lg uppercase mt-2">Overall Rating</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 border-2 border-brand-text shadow-neo">
            <h2 class="text-2xl font-bold mb-4 uppercase">Books Per Year</h2>
            <canvas id="booksByYearChart"></canvas>
        </div>
        <div class="bg-white p-6 border-2 border-brand-text shadow-neo">
            <h2 class="text-2xl font-bold mb-4 uppercase">Rating Per Year</h2>
            <canvas id="avgRatingByYearChart"></canvas>
        </div>
    </div>

    <!-- Preferences: Genres & Authors -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white p-6 border-2 border-brand-text shadow-neo">
            <h2 class="text-2xl font-bold mb-4 uppercase">Top Genres</h2>
            {% if dna.top_genres %}
                <ol class="space-y-2 text-lg">
                {% for genre, count in dna.top_genres.items %}
                    <li class="capitalize"><span class="font-bold bg-brand-yellow px-2 py-1 border-2 border-brand-text">{{ genre }}</span> ({{ count }} books)</li>
                {% endfor %}
                </ol>
            {% else %}
                <p class="text-lg">Not enough genre data to display.</p>
            {% endif %}
        </div>
        <div class="bg-white p-6 border-2 border-brand-text shadow-neo">
            <h2 class="text-2xl font-bold mb-4 uppercase">Top Authors</h2>
            {% if dna.top_authors %}
                <ol class="space-y-2 text-lg">
                {% for author, count in dna.top_authors.items %}
                    <li><span class="font-bold bg-brand-cyan px-2 py-1 border-2 border-brand-text">{{ author }}</span> ({{ count }} books)</li>
                {% endfor %}
                </ol>
            {% else %}
                <p class="text-lg">Not enough author data to display.</p>
            {% endif %}
        </div>
    </div>

    <!-- Review Analysis -->
    <div class="bg-white p-6 border-2 border-brand-text shadow-neo">
        <h2 class="text-2xl font-bold mb-4 uppercase">Review Analysis</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-lg">
            <div>
                <h3 class="font-bold text-xl uppercase">Most Positive Review</h3>
                {% if dna.most_positive_review %}
                    <p class="font-bold mt-2">{{ dna.most_positive_review.Title }}</p>
                    <blockquote class="mt-2 p-3 bg-gray-100 border-2 border-brand-text shadow-neo-sm">
                        "{{ dna.most_positive_review.my_review }}"
                    </blockquote>
                {% else %}
                    <p class="mt-2">No reviews found.</p>
                {% endif %}
            </div>
            <div>
                <h3 class="font-bold text-xl uppercase">Most Negative Review</h3>
                {% if dna.most_negative_review %}
                    <p class="font-bold mt-2">{{ dna.most_negative_review.Title }}</p>
                    <blockquote class="mt-2 p-3 bg-gray-100 border-2 border-brand-text shadow-neo-sm">
                        "{{ dna.most_negative_review.my_review }}"
                    </blockquote>
                {% else %}
                    <p class="mt-2">No reviews found.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ============================================= -->
    <!-- === ADD THIS SECTION BACK IN === -->
    <!-- ============================================= -->
    <!-- Controversial Ratings -->
    <div class="bg-white p-6 border-2 border-brand-text shadow-neo">
        <h2 class="text-2xl font-bold mb-4 uppercase">Most "Controversial" Ratings ðŸ¤¯</h2>
        <p class="text-lg mb-4">Books where your rating differs most from the Goodreads average.</p>
        <div class="space-y-4 text-lg">
            {% for book in dna.top_controversial_books %}
                <div class="p-3 bg-gray-50 border-2 border-brand-text shadow-neo-sm">
                    <p class="font-bold">{{ book.Title }}</p>
                    <div class="flex justify-between items-center mt-1 text-base">
                        <span>Your Rating: <span class="font-bold text-xl">{{ book.my_rating|floatformat:1 }}â˜…</span></span>
                        <span>Goodreads Avg: <span class="font-bold text-xl">{{ book.average_rating|floatformat:1 }}â˜…</span></span>
                        <span class="bg-brand-purple text-brand-text font-bold px-2 py-1 border-2 border-brand-text">Diff: {{ book.rating_difference|floatformat:1 }}</span>
                    </div>
                </div>
            {% empty %}
                <p>Not enough data to calculate controversial ratings.</p>
            {% endfor %}
        </div>
    </div>
    <!-- ============================================= -->
    <!-- === END OF SECTION TO ADD === -->
    <!-- ============================================= -->


    <!-- ============================================= -->
    <!-- === ADD THIS SECTION BACK IN === -->
    <!-- ============================================= -->
    <!-- CTA to Save -->
    {% if not user.is_authenticated %}
    <div class="bg-brand-purple p-6 border-2 border-brand-text shadow-neo text-center">
        <h2 class="text-2xl font-bold uppercase">Enjoying Your Readprint?</h2>
        <p class="text-lg mt-2">
            <a href="{% url 'core:signup' %}" class="underline hover:bg-brand-yellow">Create a free account</a>
            to save your DNA, track your history, and share it with friends.
        </p>
    </div>
    {% endif %}
    <!-- ============================================= -->
    <!-- === END OF SECTION TO ADD === -->
    <!-- ============================================= -->

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const dnaData = JSON.parse(document.getElementById('dna-data').textContent);
    // ... (Your chart script is perfect and does not need to be changed) ...
    Chart.defaults.font.family = 'VT323';
    Chart.defaults.font.size = 16;
    Chart.defaults.color = '#1f2937';
    const booksByYearCtx = document.getElementById('booksByYearChart').getContext('2d');
    new Chart(booksByYearCtx, {
        type: 'bar',
        data: {
            labels: dnaData.stats_by_year.map(d => d.year),
            datasets: [{
                label: '# of Books',
                data: dnaData.stats_by_year.map(d => d.count),
                backgroundColor: '#fde047',
                borderColor: '#1f2937',
                borderWidth: 2
            }]
        },
        options: { 
            plugins: { legend: { display: false } },
            scales: { 
                y: { beginAtZero: true, grid: { color: '#e5e7eb' }, ticks: { stepSize: 1 } }, 
                x: { grid: { display: false } } 
            } 
        }
    });
    const avgRatingByYearCtx = document.getElementById('avgRatingByYearChart').getContext('2d');
    new Chart(avgRatingByYearCtx, {
        type: 'line',
        data: {
            labels: dnaData.stats_by_year.map(d => d.year),
            datasets: [{
                label: 'Average Rating',
                data: dnaData.stats_by_year.map(d => d.avg_rating),
                borderColor: '#f9a8d4',
                backgroundColor: 'rgba(249, 168, 212, 0.2)',
                borderWidth: 3,
                pointBackgroundColor: '#1f2937',
                pointBorderColor: '#fde047',
                pointBorderWidth: 2,
                pointRadius: 5,
                fill: true,
                tension: 0.1
            }]
        },
        options: { 
            plugins: { legend: { display: false } },
            scales: { 
                y: { beginAtZero: false, suggestedMin: 2, suggestedMax: 5, grid: { color: '#e5e7eb' } }, 
                x: { grid: { display: false } } 
            } 
        }
    });
});
</script>
{% endblock %}
